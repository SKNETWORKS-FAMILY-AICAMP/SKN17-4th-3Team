{% extends 'layout/base.html' %}
{% load static %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Chat Choice</title>
  <link rel="stylesheet" href="{% static 'css/chat_style.css' %}">
</head>
<body>
{% block style %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock style %}
{% block content %}
{% comment %} 채팅 나오는 창 구현 {% endcomment %}
<div class="chat-container">
  <!-- 챗봇 메시지 -->
  <div class="bot-message">
      <div class="message-bubble bot">{{ chat.area }}에서 누구와 어떤 여행을 하고 싶은지 저에게 알려주세요!!</div>
  </div>

  <!-- 사용자 메시지 -->
   {% for c in chat_log %}
    <div class="user-message">
        <div class="message-bubble user">
            {{ c.question }}
        </div>
    </div>

    <div class="bot-message">
        <div class="message-bubble bot">
          {{ c.answer }}
      </div>
    </div>
    {% endfor %}
</div>

<aside class="sidebar">
  <br></br>
  <div class="top-actions">
    <form action="{% url 'chat:logout' %}" method="post">
      {% csrf_token %}
      <button type="submit" class="btn destructive">로그아웃</button>
    </form>
    <button type="button" class="btn primary">비밀번호 변경</button>
    <button type='button' id="newChatBtn" class="btn primary" onclick="location.href='{% url 'chat:chat_choice' %}'">새 채팅</button>
    <button type='button' class="btn destructive">삭제</button>
  </div>
  
  {% comment %} <div class="chat-list">
    <div class="chat-item">
      <input type="checkbox">
      <div class="date">2025-10-10 대전</div>
    </div>
    <div class="chat-item active">
      <input type="checkbox" checked>
      <div class="date">2025-10-08 서울(1)</div>
    </div>
    <div class="chat-item">
      <input type="checkbox">
      <div class="date">2025-10-08 서울</div>
    </div>
  </div> {% endcomment %}

  <div class="chat-list">
    {% for chat_item in chats %}
    <div class="chat-item {% if chat_item.id == active_chat_id %}active{% endif %}">
      <!-- 체크박스 -->
      <input type="checkbox" name="selected_chat" value="{{ chat_item.id }}">
      <!-- 날짜 텍스트 부분에만 링크 걸기 -->
      <div class="date">
        <a href="{% url 'chat:chat_main_with_id' chat_item.id %}" style="color:inherit; text-decoration:none;">
          {{ chat_item.created_at|date:"Y-m-d" }} {{ chat_item.area }}
        </a>
      </div>
    </div>
    {% empty %}
    <div class="chat-item">
      <div class="date">채팅 기록이 없습니다.</div>
    </div>
    {% endfor %}
  </div>

  <a href="{% url 'chat:withdraw' %}" class="delete-account-btn">회원탈퇴</a>
</aside>

<div class="style1">
  <textarea id="message" sendbox="메시지를 입력하세요" onkeyup="lettercount(this)" maxlength="500"></textarea>
  <span id="counter">(0/500)</span>
  <button class="send">전송</button>
</div>

<script>
    function lettercount(e) {
        const max = e.getAttribute('maxlength') || 500;
        const len = e.value.length;
        document.getElementById("counter").textContent = `(${len}/${max})`;
    }

    function getCookie(name) {
      if(document.cookie && document.cookie !== '') {
        // console.log(document.cookie);
        const cookies = document.cookie.split(';');
        // console.log('쿠키 길이:', cookies.length)

        for(let i=0;i<cookies.length;i++) {
          const cookie = cookies[i].trim();
          // console.log('쿠키 정보', i+1, cookie)

          if (cookie.substring(0, name.length) === name) {
            // console.log('쿠키:', cookie.substring(name.length + 1))
            return decodeURIComponent(cookie.substring(name.length + 1));
          }
        }
      }

      return null;
    }

    document.querySelector('.send').addEventListener('click', async () => {
        const textarea = document.getElementById('message');
        const sendBtn = document.querySelector('.send');
        const chatContainer = document.querySelector('.chat-container');
        const text = textarea.value.trim();
        if (text === '') return;

        // 전송 이후로 disable 시킴
        textarea.disabled = true;
        sendBtn.disabled = true;

        // 사용자 메시지 추가
        const userMsg = document.createElement('div');
        userMsg.classList.add('user-message');
        const userMsgBubble = document.createElement('div');
        userMsgBubble.classList.add('message-bubble', 'user');
        userMsgBubble.textContent = text;
        userMsg.appendChild(userMsgBubble);
        chatContainer.appendChild(userMsg);
        
        // 응답 중 메시지 추가
        const botMsg = document.createElement('div');
        botMsg.classList.add('bot-message');
        const botMsgBubble = document.createElement('div');
        botMsgBubble.classList.add('message-bubble', 'bot')
        botMsgBubble.textContent = '응답 생성중...';
        botMsg.appendChild(botMsgBubble);
        chatContainer.appendChild(botMsg);

        // 입력창 초기화
        textarea.value = '';
        document.getElementById("counter").textContent = "(0/500)";
        
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // csrftoken을 cookie에서 추출 후 fetch로 POST 요청 보내기
        csrftoken = getCookie('csrftoken')
        const res = await fetch("{% url 'chat:save_message' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify({
            user_id: "{{ chat.user_id }}",
            chat_id: "{{ chat.id }}",
            question: text,
          }),
        });
        
        const data = await res.json();
        console.log(data);

        if(data.status === 'ok') {
          botMsgBubble.textContent = data.answer;
        }
        else {
          botMsgBubble.textContent = '오류 발생';
        }

        textarea.disabled = false;
        sendBtn.disabled = false;
        
        // 자동 스크롤
        chatContainer.scrollTop = document.querySelector('.chat-container').scrollHeight;
    });

</script>

{% endblock content %}
</script>
  {% include 'chat/chat_choice.html' %}
  <script src="{% static 'js/regionchoice.js' %}"></script>
</body>
</html>
