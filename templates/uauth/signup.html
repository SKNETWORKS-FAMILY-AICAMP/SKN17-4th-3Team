{% extends 'layout/base.html' %}
{% load static %}

{% block title %}회원가입 | 떠나봄{% endblock title %}

{% block extra_head %}
    <link rel="stylesheet" href = "{% static 'css/signup.css' %}">
{% endblock extra_head%}

{% block content %}
<div class="signup-box">
    <form id='signup-form' method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        {% comment %} <h2>회원가입</h2> {% endcomment %}

        <div class="form-group">
            <label for="id_email">이메일</label>
            <div class="input-content-group"><div class="input-row">
                    {{ form.email }}
                    <button type='button' id='check-email-btn' class="small-btn">중복 확인</button>
                    <button type='button' id='send-code-btn' class="small-btn" style="display:none;">인증코드 발급</button>
                </div>
                <span id="email-message" class="guide-text">이메일을 입력하세요.</span>
            </div>
        </div>

        {% comment %} 이메일 인증코드 입력칸 {% endcomment %}
        <div class="form-group" id="verify-section" style="display:none;">
        <label for="verification_code">인증코드 입력</label>
            <div class="input-content-group">
                <div class="input-row">
                    <input type="text" id="verification_code" name="verification_code" placeholder="인증코드 6자리 입력" class="form-control small-input">
                    <span id="timer" class="guide-text"></span>
                    <button type="button" id="verify-code-btn" class="small-btn">인증 확인</button>
                </div>
            <span id="verify-message" class="guide-text"></span>
            
            </div>
        </div>
        <div class="form-group">
            <label for="id_password1">비밀번호 입력</label>
            <div class="input-content-group">
                <div class="input-row">{{ form.password1 }}</div> <span id="pw1-message" class="guide-text">4~15자 사이의 영어 대/소문자, 숫자를 사용하세요.</span>
            </div>
        </div>

        <div class="form-group">
            <label for="id_password2">비밀번호 확인</label>
            <div class="input-content-group">
                <div class="input-row">{{ form.password2 }}</div> <span id="pw2-message" class="guide-text"></span>
            </div>
        </div>

        <div class="form-group">
            <label for="id_nickname">닉네임</label>
            <div class="input-content-group">
                <div class="input-row">{{ form.nickname }}</div>
                <span id="nickname-message" class="guide-text">2~10자 사이의 한국어, 영어만 사용 가능합니다.</span>
            </div>
        </div>

        {{ form.username }}

        <div class = "button-group">
            <button type="submit" class="signup-btn">회원가입</button>
        </div>
        {% for error in form.non_field_errors %}
            <span id="form-error" class="error-text">{{ error }}</span>
        {% endfor %}
        <span id = "js-form-error" class="error-text"></span>
    </form>
</div>

<script>
    let isEmailChecked = false;
    let isEmailValidFormat = false;
    let isPwValidFormat = false;
    let isPwMatch = false;
    let isNicknameValid = false;

    document.getElementById('id_email').addEventListener('input', () => {
        const email = document.getElementById('id_email').value;
        const msg = document.getElementById('email-message');
        isEmailChecked = false; 
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; 

        if (email === '') {
            msg.style.color = 'black';
            msg.textContent = '이메일을 입력하세요.';
            isEmailValidFormat = false;
        } else if (!emailRegex.test(email)) {
            msg.style.color = 'red';
            msg.textContent = '올바른 이메일 형식이 아닙니다.';
            isEmailValidFormat = false;
        } else {
            msg.style.color = 'black';
            msg.textContent = '중복 확인을 해주세요.';
            isEmailValidFormat = true;
        }
    });

    // 이메일 중복 확인
    document.getElementById('check-email-btn').addEventListener('click', async () => {
        const email = document.getElementById('id_email').value;
        const msg = document.getElementById('email-message');

        if (!email){
            msg.style.color = 'red';
            msg.textContent = '이메일을 입력하세요.';
            isEmailChecked = false;
            return;
        }

        const response = await fetch(`/uauth/check_email/?email=${email}`);
        const data = await response.json();

        if(data.exists){
            msg.style.color = 'red';
            msg.textContent = '이미 가입되어있는 이메일입니다.';
            isEmailChecked = false;
        } else{
            msg.style.color = 'blue';
            msg.textContent = '가입할 수 있는 이메일입니다.';
            isEmailChecked = true;
        }
    });

    //이메일 인증코드 관련 코드


    // 비밀번호 체크
    document.getElementById('id_password1').addEventListener('input', () => {
        const pw = document.getElementById('id_password1').value;
        const msg = document.getElementById('pw1-message');
        const regex = /^[A-Za-z0-9]{4,15}$/;

        if (pw === ''){
            msg.style.color = 'black';
            msg.textContent = '4~15자 사이의 영어 대/소문자, 숫자를 사용하세요.';
            isPwValidFormat = false;
        } else if (!regex.test(pw)){
            msg.style.color = 'red';
            msg.textContent = '4~15자 사이의 영어 대/소문자, 숫자를 사용하세요.';
            isPwValidFormat = false;
        } else{
            msg.style.color = 'blue';
            msg.textContent = '사용 가능한 비밀번호입니다.';
            isPwValidFormat = true;
        }
        document.getElementById('id_password2').dispatchEvent(new Event('input'));
    });

    // 비밀번호 확인
    document.getElementById('id_password2').addEventListener('input', () => {
        const pw1 = document.getElementById('id_password1').value;
        const pw2 = document.getElementById('id_password2').value;
        const msg = document.getElementById('pw2-message');

        if (pw2 === ''){
            msg.textContent = '';
            isPwMatch = false;
        } else if (pw1 === pw2 && isPwValidFormat){
            msg.style.color = 'blue';
            msg.textContent = '비밀번호가 일치합니다.';
            isPwMatch = true;
        } else if (pw1 === pw2 && !isPwValidFormat){
            msg.style.color = 'red';
            msg.textContent = '4~15자 사이의 영어 대/소문자, 숫자를 사용하세요.';
            isPwMatch = false;
        }
        else{
            msg.style.color = 'red';
            msg.textContent = '비밀번호가 일치하지 않습니다.';
            isPwMatch = false;
        }
    });

    // 닉네임 체크
    document.getElementById('id_nickname').addEventListener('input', () => {
        const nick = document.getElementById('id_nickname').value;
        const msg = document.getElementById('nickname-message');
        const regex = /^[A-Za-z가-힣]{2,10}$/;

        if (nick === ''){
            msg.style.color = 'black';
            msg.textContent = '2~10자 사이의 한국어, 영어만 사용 가능합니다.';
            isNicknameValid = false;
        } else if (!regex.test(nick)){
            msg.style.color = 'red';
            msg.textContent = '2~10자 사이의 한국어, 영어만 사용 가능합니다.';
            isNicknameValid = false;
        } else{
            msg.style.color = 'blue';
            msg.textContent = '사용 가능한 닉네임입니다.';
            isNicknameValid = true;
        }
    });

    function validateEmail(){
        const email = document.getElementById('id_email').value.trim();
        const msg = document.getElementById('email-message');
        return email !== '' && msg.style.color === 'blue';
    }

    function validatePassword(){
        const pw = document.getElementById('id_password1').value;
        const regex = /^[A-Za-z0-9]{4,15}$/;
        return regex.test(pw);
    }

    function validatePasswordMatch(){
        const pw1 = document.getElementById('id_password1').value;
        const pw2 = document.getElementById('id_password2').value;
        return pw1 !== '' && pw1 == pw2;
    }

    function validateNickname(){
        const nick = document.getElementById('id_nickname').value;
        const regex = /^[A-Za-z가-힣]{2,10}$/;
        return regex.test(nick);
    }

    document.getElementById('signup-form').addEventListener('submit', (e) => {
        const formError = document.getElementById('js-form-error');
        formError.textContent = ''; // JS 에러 메시지 초기화
        
        const isEmailFinal = isEmailChecked;
        const isPwFinal = isPwValidFormat && isPwMatch;
        const isNickFinal = isNicknameValid;
        
        if (!isEmailFinal || !isPwFinal || !isNickFinal) {
            e.preventDefault(); // 폼 전송 중단
            
            // 모든 정보가 입력/확인되지 않았을 때 메시지 표시 (요청하신 부분)
            formError.textContent = '모든 정보를 입력해주세요.';
            
            // 세부 워닝 메시지 재실행
            if (!isEmailChecked) {
                document.getElementById('email-message').style.color = 'red';
                document.getElementById('email-message').textContent = '이메일 중복 확인을 완료해주세요.';
            }
            if (!isPwValidFormat) {
                document.getElementById('pw1-message').style.color = 'red';
            }
            if (!isPwMatch) {
                document.getElementById('pw2-message').style.color = 'red';
            }
            if (!isNicknameValid) {
                document.getElementById('nickname-message').style.color = 'red';
            }
        }
    });
</script>
{% endblock content %}
