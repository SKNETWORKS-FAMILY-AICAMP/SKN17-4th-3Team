{% extends 'layout/base.html' %}
{% load static %}

{% block title %}회원가입 | 떠나봄{% endblock title %}

{% block extra_head %}
    <link rel="stylesheet" href = "{% static 'css/signup.css' %}">
{% endblock extra_head%}

{% block content %}
<div class="signup-box">
    <form id='signup-form' method="POST"  action="{% url 'uauth:signup' %}" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="form-group">
            <label for="id_email">이메일</label>
            <div class="input-content-group" type='email'><div class="input-row">
                    {{ form.email }}
                    <button type='button' id='check-email-btn' class="small-btn">중복 확인</button>
                    <button type='button' id='send-code-btn' class="small-btn">인증코드 발급</button>
                </div>
                <span id="email-message" class="guide-text">이메일을 입력하세요.</span>
            </div>
        </div>

        {% comment %} 이메일 인증코드 입력칸 {% endcomment %}
        <div class="form-group" id="verify-section" >
        <label for="verification_code">인증코드 입력</label>
            <div class="input-content-group">
               <div class="input-row">
                    <input type="text" id="verification_code" name="verification_code" placeholder="인증코드 6자리 입력" class="form-control small-input">
                    <span id="timer" class="guide-text"></span>
                    <button type="button" id="verify-code-btn" class="small-btn">인증 확인</button>
                    <button type='button' id='resend-code-btn' class="resend-code-btn">인증코드 재전송</button>
                </div>
            <span id="verify-message" class="guide-text"></span>
             
            </div>
        </div>
        <div class="form-group">
            <label for="id_password1">비밀번호 입력</label>
            <div class="input-content-group">
                <div class="input-row">{{ form.password1 }}</div> 
                <span id="pw1-message" class="guide-text">4~15자 사이의 영어 대/소문자, 숫자를 사용하세요.</span>
            </div>
        </div>

        <div class="form-group">
            <label for="id_password2">비밀번호 확인</label>
            <div class="input-content-group">
                <div class="input-row">{{ form.password2 }}</div> 
                <span id="pw2-message" class="guide-text"></span>
            </div>
        </div>

        <div class="form-group">
            <label for="id_nickname">닉네임</label>
            <div class="input-content-group">
                <div class="input-row">{{ form.nickname }}</div>
                <span id="nickname-message" class="guide-text">2~10자 사이의 한국어, 영어만 사용 가능합니다.</span>
            </div>
        </div>

        {{ form.username }}
        {% for error in form.non_field_errors %}
            <span id="form-error" class="error-text">{{ error }}</span>
        {% endfor %}
        <span id = "js-form-error" class="error-text"></span>
        <div class = "button-group">
            <button type="submit" class="signup-btn" id='signup-btn'>회원가입</button>
        </div>
    </form>
</div>
{% include 'uauth/signup_modal.html' with page_type='signup' %}
<script>document.addEventListener('DOMContentLoaded', function() {
  console.log("✅ signup.js loaded");

  // ============================================
  // 미피 기존 코드 전체를 여기에 그대로 넣어
  // ============================================

  // ✅ CSRF 토큰 가져오기 함수 추가
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  document.getElementById('signup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formError = document.getElementById('js-form-error');
    formError.textContent = '';

    const isEmailFinal = isEmailChecked;
    const isPwFinal = isPwValidFormat && isPwMatch;
    const isNickFinal = isNicknameValid;

    if (!isEmailVerified) {
      formError.textContent = '이메일 인증을 완료해주세요.';
      verifyMsg.style.color = 'red';
      verifyMsg.textContent = '이메일 인증을 완료해야 회원가입이 가능합니다.';
      return;
    }

    if (!isEmailFinal || !isPwFinal || !isNickFinal) {
      formError.textContent = '모든 정보를 입력해주세요.';
      if (!isEmailChecked) {
        document.getElementById('email-message').style.color = 'red';
        document.getElementById('email-message').textContent = '이메일 중복 확인을 완료해주세요.';
      }
      return;
    }

    // ✅ 회원가입 요청 전송
    try {
      const form = e.target;
      const response = await fetch(form.action, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: new FormData(form),
      });

      if (response.ok) {
        const modal = document.getElementById('successModal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
      } else {
        const data = await response.json();
        console.error(data);
        formError.textContent = '회원가입 중 오류가 발생했습니다.';
      }
    } catch (error) {
      console.error(error);
      formError.textContent = '서버와 연결할 수 없습니다.';
    }
  });
});</script>
<script src="{% static 'js/signup.js' %}"></script>
{% endblock content %}
